"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CdpCookieProvider = void 0;
const url_1 = require("url");
const base_1 = require("../test-run/cookies/base");
const match_collection_1 = __importDefault(require("../utils/match-collection"));
const get_active_client_1 = require("./utils/get-active-client");
const set_cookie_parser_1 = require("set-cookie-parser");
const lodash_1 = require("lodash");
const MAX_TIMESTAMP = 8640000000000000;
class CdpCookieProvider extends base_1.CookieProviderBase {
    async _getCdpClient() {
        const browserConnection = this.testRun.browserConnection;
        return (0, get_active_client_1.getActiveClient)(browserConnection);
    }
    async initialize() {
        return this.deleteCookies();
    }
    async getCookies(externalCookies) {
        const client = await this._getCdpClient();
        const { cookies } = await client.Storage.getCookies({});
        return (0, match_collection_1.default)(cookies, externalCookies).map(this._cdpCookieToExternalCookie);
    }
    async setCookies(cookies, url) {
        const client = await this._getCdpClient();
        const { hostname = '', pathname = '/' } = url ? new url_1.URL(url) : {};
        const cookiesArray = (0, lodash_1.castArray)(cookies);
        const parsedCookies = this._isCookieOptionsArray(cookiesArray)
            ? cookiesArray
            : this._parseSetCookieStrings(cookiesArray);
        await client.Network.setCookies({
            cookies: parsedCookies.map(cookie => this._cookieOptionToCdpCookieParam(cookie, hostname, pathname)),
        });
    }
    async deleteCookies(cookies = [], urls = []) {
        const client = await this._getCdpClient();
        if (!cookies || !cookies.length)
            return client.Network.clearBrowserCookies();
        const parsedUrls = this._parseUrls(urls);
        let existingCookies = await this.getCookies([]);
        if (parsedUrls.length) {
            existingCookies = existingCookies.filter(cookie => parsedUrls
                .find(url => url.domain === cookie.domain && url.path === cookie.path));
        }
        existingCookies = (0, match_collection_1.default)(existingCookies, cookies);
        for (const cookie of existingCookies) {
            await client.Network.deleteCookies({
                name: cookie.name || '',
                domain: cookie.domain,
                path: cookie.path,
            });
        }
        return void 0;
    }
    async getCookieHeader(url) {
        const [{ domain, path }] = this._parseUrls([url]);
        const cookies = await this.getCookies([{ domain }]);
        const filteredCookies = cookies.filter(c => this._includesPath(c.path || '/', path));
        return filteredCookies.map(c => `${c.name}=${c.value}`).join(';');
    }
    _cdpCookieToExternalCookie(cookie) {
        var _a;
        return {
            name: cookie.name,
            value: cookie.value,
            domain: cookie.domain,
            maxAge: void 0,
            path: cookie.path,
            expires: void 0,
            secure: cookie.secure,
            httpOnly: cookie.httpOnly,
            sameSite: (_a = cookie.sameSite) !== null && _a !== void 0 ? _a : 'none',
        };
    }
    _cookieOptionToCdpCookieParam(cookie, hostname, pathname) {
        var _a, _b, _c;
        return {
            name: cookie.name,
            value: cookie.value,
            domain: (_a = cookie.domain) !== null && _a !== void 0 ? _a : hostname,
            path: (_b = cookie.path) !== null && _b !== void 0 ? _b : pathname,
            secure: cookie.secure,
            httpOnly: false,
            sameSite: cookie.sameSite,
            expires: ((_c = cookie.expires) === null || _c === void 0 ? void 0 : _c.getTime()) || MAX_TIMESTAMP,
        };
    }
    _parseUrls(urls) {
        return urls.map(url => {
            const { hostname, pathname } = new url_1.URL(url);
            return { domain: hostname, path: pathname };
        });
    }
    _includesPath(cookiePath, urlPath) {
        if (cookiePath === '/')
            return true;
        const cookieParts = cookiePath.split('/');
        const urlParts = urlPath.split('/');
        if (cookieParts.length > urlParts.length)
            return false;
        while (cookieParts.length) {
            if (cookieParts.shift() !== urlParts.shift())
                return false;
        }
        return true;
    }
    _parseSetCookieStrings(cookies) {
        return (0, set_cookie_parser_1.parse)(cookies);
    }
}
exports.CdpCookieProvider = CdpCookieProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29va2llLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL25hdGl2ZS1hdXRvbWF0aW9uL2Nvb2tpZS1wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFJQSw2QkFBMEI7QUFFMUIsbURBQThFO0FBRTlFLGlGQUF3RDtBQUN4RCxpRUFBNEQ7QUFDNUQseURBQTBDO0FBQzFDLG1DQUFtQztBQUluQyxNQUFNLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQztBQUV2QyxNQUFhLGlCQUFrQixTQUFRLHlCQUFrQjtJQUM3QyxLQUFLLENBQUMsYUFBYTtRQUN2QixNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7UUFFekQsT0FBTyxJQUFBLG1DQUFlLEVBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVU7UUFDWixPQUFPLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FBRSxlQUFrQztRQUNoRCxNQUFNLE1BQU0sR0FBUSxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUMvQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV4RCxPQUFRLElBQUEsMEJBQWUsRUFBQyxPQUFPLEVBQUUsZUFBZSxDQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0lBQ3hHLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUFFLE9BQTRDLEVBQUUsR0FBVztRQUN2RSxNQUFNLE1BQU0sR0FBOEIsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckUsTUFBTSxFQUFFLFFBQVEsR0FBRyxFQUFFLEVBQUUsUUFBUSxHQUFHLEdBQUcsRUFBRSxHQUFH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QUVPLGFBQWEsQ0FBRSxVQUFrQixFQUFFLE9BQWU7UUFDdEQsSUFBSSxVQUFVLEtBQUssR0FBRztZQUNsQixPQUFPLElBQUksQ0FBQztRQUVoQixNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLE1BQU0sUUFBUSxHQUFNLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdkMsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNO1lBQ3BDLE9BQU8sS0FBSyxDQUFDO1FBRWpCLE9BQU8sV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUN2QixJQUFJLFdBQVcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxRQUFRLENBQUMsS0FBSyxFQUFFO2dCQUN4QyxPQUFPLEtBQUssQ0FBQztTQUNwQjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTyxzQkFBc0IsQ0FBRSxPQUFpQjtRQUM3QyxPQUFPLElBQUEseUJBQUssRUFBQyxPQUFPLENBQW9CLENBQUM7SUFDN0MsQ0FBQztDQUNKO0FBM0hELDhDQTJIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZW1vdGVDaHJvbWUgZnJvbSAnY2hyb21lLXJlbW90ZS1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgRXh0ZXJuYWxDb29raWVzIH0gZnJvbSAndGVzdGNhZmUtaGFtbWVyaGVhZCc7XG5pbXBvcnQgUHJvdG9jb2wgZnJvbSAnZGV2dG9vbHMtcHJvdG9jb2wnO1xuaW1wb3J0IENvb2tpZSA9IFByb3RvY29sLk5ldHdvcmsuQ29va2llO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IENvb2tpZU9wdGlvbnMgfSBmcm9tICcuLi90ZXN0LXJ1bi9jb21tYW5kcy9vcHRpb25zJztcbmltcG9ydCB7IENvb2tpZVByb3ZpZGVyLCBDb29raWVQcm92aWRlckJhc2UgfSBmcm9tICcuLi90ZXN0LXJ1bi9jb29raWVzL2Jhc2UnO1xuaW1wb3J0IENvb2tpZVBhcmFtID0gUHJvdG9jb2wuTmV0d29yay5Db29raWVQYXJhbTtcbmltcG9ydCBtYXRjaENvbGxlY3Rpb24gZnJvbSAnLi4vdXRpbHMvbWF0Y2gtY29sbGVjdGlvbic7XG5pbXBvcnQgeyBnZXRBY3RpdmVDbGllbnQgfSBmcm9tICcuL3V0aWxzL2dldC1hY3RpdmUtY2xpZW50JztcbmltcG9ydCB7IHBhcnNlIH0gZnJvbSAnc2V0LWNvb2tpZS1wYXJzZXInO1xuaW1wb3J0IHsgY2FzdEFycmF5IH0gZnJvbSAnbG9kYXNoJztcblxuZGVjbGFyZSB0eXBlIENvb2tpZVNhbWVTaXRlID0gJ0xheCcgfCAnU3RyaWN0JyB8ICdOb25lJztcblxuY29uc3QgTUFYX1RJTUVTVEFNUCA9IDg2NDAwMDAwMDAwMDAwMDA7XG5cbmV4cG9ydCBjbGFzcyBDZHBDb29raWVQcm92aWRlciBleHRlbmRzIENvb2tpZVByb3ZpZGVyQmFzZSBpbXBsZW1lbnRzIENvb2tpZVByb3ZpZGVyIHtcbiAgICBwcml2YXRlIGFzeW5jIF9nZXRDZHBDbGllbnQgKCk6IFByb21pc2U8cmVtb3RlQ2hyb21lLlByb3RvY29sQXBpPiB7XG4gICAgICAgIGNvbnN0IGJyb3dzZXJDb25uZWN0aW9uID0gdGhpcy50ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uO1xuXG4gICAgICAgIHJldHVybiBnZXRBY3RpdmVDbGllbnQoYnJvd3NlckNvbm5lY3Rpb24pO1xuICAgIH1cblxuICAgIGFzeW5jIGluaXRpYWxpemUgKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kZWxldGVDb29raWVzKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0Q29va2llcyAoZXh0ZXJuYWxDb29raWVzOiBFeHRlcm5hbENvb2tpZXNbXSk6IFByb21pc2U8RXh0ZXJuYWxDb29raWVzW10+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ICAgICAgPSBhd2FpdCB0aGlzLl9nZXRDZHBDbGllbnQoKTtcbiAgICAgICAgY29uc3QgeyBjb29raWVzIH0gPSBhd2FpdCBjbGllbnQuU3RvcmFnZS5nZXRDb29raWVzKHt9KTtcblxuICAgICAgICByZXR1cm4gKG1hdGNoQ29sbGVjdGlvbihjb29raWVzLCBleHRlcm5hbENvb2tpZXMpIGFzIENvb2tpZVtdKS5tYXAodGhpcy5fY2RwQ29va2llVG9FeHRlcm5hbENvb2tpZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0Q29va2llcyAoY29va2llczogc3RyaW5nIHwgc3RyaW5nW10gfCBDb29raWVPcHRpb25zW10sIHVybDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IGF3YWl0IHRoaXMuX2dldENkcENsaWVudCgpO1xuICAgICAgICBjb25zdCB7IGhvc3RuYW1lID0gJycsIHBhdGhuYW1lID0gJy8nIH0gPSB1cmwgPyBuZXcgVVJMKHVybCkgOiB7fTtcbiAgICAgICAgY29uc3QgY29va2llc0FycmF5ICAgICAgICAgICAgICAgICAgICAgID0gY2FzdEFycmF5PHN0cmluZyB8IENvb2tpZU9wdGlvbnM+KGNvb2tpZXMpO1xuXG4gICAgICAgIGNvbnN0IHBhcnNlZENvb2tpZXMgPSB0aGlzLl9pc0Nvb2tpZU9wdGlvbnNBcnJheShjb29raWVzQXJyYXkpXG4gICAgICAgICAgICA/IGNvb2tpZXNBcnJheVxuICAgICAgICAgICAgOiB0aGlzLl9wYXJzZVNldENvb2tpZVN0cmluZ3MoY29va2llc0FycmF5IGFzIHN0cmluZ1tdKTtcblxuICAgICAgICBhd2FpdCBjbGllbnQuTmV0d29yay5zZXRDb29raWVzKHtcbiAgICAgICAgICAgIGNvb2tpZXM6IHBhcnNlZENvb2tpZXMubWFwKGNvb2tpZSA9PiB0aGlzLl9jb29raWVPcHRpb25Ub0NkcENvb2tpZVBhcmFtKGNvb2tpZSwgaG9zdG5hbWUsIHBhdGhuYW1lKSksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGRlbGV0ZUNvb2tpZXMgKGNvb2tpZXM6IENvb2tpZU9wdGlvbnNbXSA9IFtdLCB1cmxzOiBzdHJpbmdbXSA9IFtdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IGF3YWl0IHRoaXMuX2dldENkcENsaWVudCgpO1xuXG4gICAgICAgIGlmICghY29va2llcyB8fCAhY29va2llcy5sZW5ndGgpXG4gICAgICAgICAgICByZXR1cm4gY2xpZW50Lk5ldHdvcmsuY2xlYXJCcm93c2VyQ29va2llcygpO1xuXG4gICAgICAgIGNvbnN0IHBhcnNlZFVybHMgICAgPSB0aGlzLl9wYXJzZVVybHModXJscyk7XG4gICAgICAgIGxldCBleGlzdGluZ0Nvb2tpZXMgPSBhd2FpdCB0aGlzLmdldENvb2tpZXMoW10pO1xuXG4gICAgICAgIGlmIChwYXJzZWRVcmxzLmxlbmd0aCkge1xuICAgICAgICAgICAgZXhpc3RpbmdDb29raWVzID0gZXhpc3RpbmdDb29raWVzLmZpbHRlcihjb29raWUgPT4gcGFyc2VkVXJsc1xuICAgICAgICAgICAgICAgIC5maW5kKHVybCA9PiB1cmwuZG9tYWluID09PSBjb29raWUuZG9tYWluICYmIHVybC5wYXRoID09PSBjb29raWUucGF0aCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgZXhpc3RpbmdDb29raWVzID0gbWF0Y2hDb2xsZWN0aW9uKGV4aXN0aW5nQ29va2llcywgY29va2llcykgYXMgRXh0ZXJuYWxDb29raWVzW107XG5cbiAgICAgICAgZm9yIChjb25zdCBjb29raWUgb2YgZXhpc3RpbmdDb29raWVzKSB7XG4gICAgICAgICAgICBhd2FpdCBjbGllbnQuTmV0d29yay5kZWxldGVDb29raWVzKHtcbiAgICAgICAgICAgICAgICBuYW1lOiAgIGNvb2tpZS5uYW1lIHx8ICcnLFxuICAgICAgICAgICAgICAgIGRvbWFpbjogY29va2llLmRvbWFpbixcbiAgICAgICAgICAgICAgICBwYXRoOiAgIGNvb2tpZS5wYXRoLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdm9pZCAwO1xuICAgIH1cblxuICAgIGFzeW5jIGdldENvb2tpZUhlYWRlciAodXJsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICAgICAgY29uc3QgW3sgZG9tYWluLCBwYXRoIH1dID0gdGhpcy5fcGFyc2VVcmxzKFt1cmxdKTtcbiAgICAgICAgY29uc3QgY29va2llcyAgICAgICAgICAgID0gYXdhaXQgdGhpcy5nZXRDb29raWVzKFt7IGRvbWFpbiB9XSk7XG4gICAgICAgIGNvbnN0IGZpbHRlcmVkQ29va2llcyAgICA9IGNvb2tpZXMuZmlsdGVyKGMgPT4gdGhpcy5faW5jbHVkZXNQYXRoKGMucGF0aCB8fCAnLycsIHBhdGgpKTtcblxuICAgICAgICByZXR1cm4gZmlsdGVyZWRDb29raWVzLm1hcChjID0+IGAkeyBjLm5hbWUgfT0keyBjLnZhbHVlIH1gKS5qb2luKCc7Jyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY2RwQ29va2llVG9FeHRlcm5hbENvb2tpZSAoY29va2llOiBDb29raWUpOiBFeHRlcm5hbENvb2tpZXMge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbmFtZTogICAgIGNvb2tpZS5uYW1lLFxuICAgICAgICAgICAgdmFsdWU6ICAgIGNvb2tpZS52YWx1ZSxcbiAgICAgICAgICAgIGRvbWFpbjogICBjb29raWUuZG9tYWluLFxuICAgICAgICAgICAgbWF4QWdlOiAgIHZvaWQgMCxcbiAgICAgICAgICAgIHBhdGg6ICAgICBjb29raWUucGF0aCxcbiAgICAgICAgICAgIGV4cGlyZXM6ICB2b2lkIDAsXG4gICAgICAgICAgICBzZWN1cmU6ICAgY29va2llLnNlY3VyZSxcbiAgICAgICAgICAgIGh0dHBPbmx5OiBjb29raWUuaHR0cE9ubHksXG4gICAgICAgICAgICBzYW1lU2l0ZTogY29va2llLnNhbWVTaXRlID8/ICdub25lJyxcbiAgICAgICAgfSBhcyB1bmtub3duIGFzIEV4dGVybmFsQ29va2llcztcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jb29raWVPcHRpb25Ub0NkcENvb2tpZVBhcmFtIChjb29raWU6IENvb2tpZU9wdGlvbnMsIGhvc3RuYW1lOiBzdHJpbmcsIHBhdGhuYW1lOiBzdHJpbmcpOiBDb29raWVQYXJhbSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiAgICAgY29va2llLm5hbWUsXG4gICAgICAgICAgICB2YWx1ZTogICAgY29va2llLnZhbHVlLFxuICAgICAgICAgICAgZG9tYWluOiAgIGNvb2tpZS5kb21haW4gPz8gaG9zdG5hbWUsXG4gICAgICAgICAgICBwYXRoOiAgICAgY29va2llLnBhdGggPz8gcGF0aG5hbWUsXG4gICAgICAgICAgICBzZWN1cmU6ICAgY29va2llLnNlY3VyZSxcbiAgICAgICAgICAgIGh0dHBPbmx5OiBmYWxzZSxcbiAgICAgICAgICAgIHNhbWVTaXRlOiBjb29raWUuc2FtZVNpdGUgYXMgQ29va2llU2FtZVNpdGUsXG4gICAgICAgICAgICBleHBpcmVzOiAgY29va2llLmV4cGlyZXM/LmdldFRpbWUoKSB8fCBNQVhfVElNRVNUQU1QLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX3BhcnNlVXJscyAodXJsczogc3RyaW5nW10pOiB7IGRvbWFpbjogc3RyaW5nLCBwYXRoOiBzdHJpbmcgfVtdIHtcbiAgICAgICAgcmV0dXJuIHVybHMubWFwKHVybCA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGhvc3RuYW1lLCBwYXRobmFtZSB9ID0gbmV3IFVSTCh1cmwpO1xuXG4gICAgICAgICAgICByZXR1cm4geyBkb21haW46IGhvc3RuYW1lLCBwYXRoOiBwYXRobmFtZSB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbmNsdWRlc1BhdGggKGNvb2tpZVBhdGg6IHN0cmluZywgdXJsUGF0aDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGlmIChjb29raWVQYXRoID09PSAnLycpXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcblxuICAgICAgICBjb25zdCBjb29raWVQYXJ0cyA9IGNvb2tpZVBhdGguc3BsaXQoJy8nKTtcbiAgICAgICAgY29uc3QgdXJsUGFydHMgICAgPSB1cmxQYXRoLnNwbGl0KCcvJyk7XG5cbiAgICAgICAgaWYgKGNvb2tpZVBhcnRzLmxlbmd0aCA+IHVybFBhcnRzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICB3aGlsZSAoY29va2llUGFydHMubGVuZ3RoKSB7XG4gICAgICAgICAgICBpZiAoY29va2llUGFydHMuc2hpZnQoKSAhPT0gdXJsUGFydHMuc2hpZnQoKSlcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9wYXJzZVNldENvb2tpZVN0cmluZ3MgKGNvb2tpZXM6IHN0cmluZ1tdKTogQ29va2llT3B0aW9uc1tdIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlKGNvb2tpZXMpIGFzIENvb2tpZU9wdGlvbnNbXTtcbiAgICB9XG59XG4iXX0=